'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!(i&&_arr.length===i));_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i['return']&&_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();var _react=require('react'),_react2=_interopRequireDefault(_react),_reactDom=require('react-dom'),_slide=require('../slide'),_slide2=_interopRequireDefault(_slide),_utils=require('../utils');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _objectWithoutProperties(obj,keys){var target={};for(var i in obj)!(0<=keys.indexOf(i))&&Object.prototype.hasOwnProperty.call(obj,i)&&(target[i]=obj[i]);return target}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return call&&('object'==typeof call||'function'==typeof call)?call:self}function _inherits(subClass,superClass){if('function'!=typeof superClass&&null!==superClass)throw new TypeError('Super expression must either be null or a function, not '+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}// const tap = (msg) => (thing) => { console.log(msg, thing); return thing }
var bool=_react.PropTypes.bool,number=_react.PropTypes.number,string=_react.PropTypes.string,func=_react.PropTypes.func,array=_react.PropTypes.array,oneOfType=_react.PropTypes.oneOfType,object=_react.PropTypes.object,node=_react.PropTypes.node,wrapAroundValue=function wrapAroundValue(a,b){return(a%b+b)%b},hardBoundedValue=function hardBoundedValue(a,b){return Math.max(0,Math.min(b,a))},normalizeIndex=function normalizeIndex(a,b){var c=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return c?wrapAroundValue(a,b):hardBoundedValue(a,b-1)};var Track=function(_Component){function Track(a){_classCallCheck(this,Track);var _this=_possibleConstructorReturn(this,(Track.__proto__||Object.getPrototypeOf(Track)).call(this,a));return _this.slideTo=_this.slideTo.bind(_this),_initialiseProps.call(_this),_this.state={activeIndex:a.startAt,isAnimating:!1,visibleSlides:_this.props.visibleSlides||0,slideBy:_this.props.slideBy||_this.props.visibleSlides||0},_this.next=_this.next.bind(_this),_this.prev=_this.prev.bind(_this),_this.slideTo=_this.slideTo.bind(_this),_this}return _inherits(Track,_Component),_createClass(Track,[{key:'componentDidMount',value:function componentDidMount(){var _this2=this;this.DOMNode=(0,_reactDom.findDOMNode)(this.track),this.isInteracting=(0,_utils.hasOngoingInteraction)(this.DOMNode),this.childCount=this.track.children.length;var a={left:function left(){return-_this2.state.slideBy},right:function right(){return _this2.state.slideBy},up:function up(){return 0},down:function down(){return 0}};this.eventListeners=[].concat(_toConsumableArray(this.eventListeners),[(0,_utils.onScrollStart)(function(){_this2.isScrolling=!0}),(0,_utils.on)('touchstart')(function(){_this2.isScrolling=!0})(this.track),(0,_utils.onScrollEnd)(function(){_this2.isScrolling=!1,_this2.canSelfCorrect()&&(_this2.props.snapToSlide?_this2.slideTo(_this2.getNearestSlideIndex()).catch(_utils.noop):_this2.props.afterSlide(_this2.getNearestSlideIndex()))},{target:this.DOMNode}),(0,_utils.on)('touchend')(function(){_this2.canSelfCorrect()&&(_this2.props.snapToSlide?_this2.slideTo(_this2.getNearestSlideIndex()).catch(_utils.noop):_this2.props.afterSlide(_this2.getNearestSlideIndex()))})(this.track),(0,_utils.onSwipe)(function(b){!_this2.props.preventSwipe&&_this2.props.snapToSlide&&_this2.slideTo(_this2.state.activeIndex+a[b]()).catch(_utils.noop)})(this.track)]),this.slideTo(this.props.startAt,{immediate:!0}).catch(_utils.noop)}},{key:'componentWillUnmount',value:function componentWillUnmount(){this.eventListeners.forEach(function(a){return a()})}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(_ref){var a=_ref.slideBy,b=_ref.visibleSlides,c=_ref.preventSwipe;(a!==this.props.slideBy||b!==this.props.visibleSlides)&&this.setState({slideBy:a||b||1})}},{key:'componentDidUpdate',value:function componentDidUpdate(a){if(this.childCount=this.track.children.length,this.shouldSelfCorrect()){var b=this.getNearestSlideIndex();b!==this.state.activeIndex&&this.slideTo(this.getNearestSlideIndex()).catch(_utils.noop)}a.slideTo!==this.props.slideTo&&this.slideTo(this.props.slideTo).catch(_utils.noop)}},{key:'shouldComponentUpdate',// isAnimating state is the only important state value to the rendering of this component
value:function shouldComponentUpdate(a,_ref2){var b=_ref2.isAnimating,c=[].concat(_toConsumableArray((0,_utils.values)(this.props)),[this.state.isAnimating]),d=[].concat(_toConsumableArray((0,_utils.values)(a)),[b]);return!d.every(function(e,f){return e===c[f]})}},{key:'next',value:function next(){var a=this.childCount,b=this.props,c=this.state,d=c.activeIndex,e=c.slideBy,f=b.infinite,g=a-e;if(!e){var _getPartiallyObscured=this.getPartiallyObscuredSlides(),_getPartiallyObscured2=_slicedToArray(_getPartiallyObscured,2),k=_getPartiallyObscured2[0],l=_getPartiallyObscured2[1],m=l===a-1?0:l;return this.slideTo(f?m:l)}var h=Math.min(d+e,g),j=d===g?0:h;return this.slideTo(f?j:h)}},{key:'prev',value:function prev(){var a=this.childCount,b=this.state,c=this.props,d=b.activeIndex,e=b.slideBy,f=c.infinite,g=0;if(!e){var _getPartiallyObscured3=this.getPartiallyObscuredSlides(),_getPartiallyObscured4=_slicedToArray(_getPartiallyObscured3,1),k=_getPartiallyObscured4[0],l=k===g?a-1:k;return this.slideTo(f?l:k)}var h=Math.max(d-e,g),j=h===g?a-e:h;return this.slideTo(f?j:h)}},{key:'slideTo',value:function slideTo(a){var _this3=this,_ref3=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},_ref3$immediate=_ref3.immediate,b=void 0!==_ref3$immediate&&_ref3$immediate;if(0===this.childCount)return Promise.reject('No children to slide to');var _props=this.props,c=_props.afterSlide,d=_props.beforeSlide,e=_props.easing,f=_props.animationDuration,g=_props.infinite,h=_props.preventScroll,_track=this.track,j=_track.children,k=_track.scrollLeft,l=normalizeIndex(a,this.childCount,g),m=this.state.activeIndex;if(m===l)return Promise.resolve(l);var n=j[l].offsetLeft-k;return d(a),this.setState({isAnimating:!0,activeIndex:l}),new Promise(function(o){if(b)return _this3.track.scrollLeft=j[l].offsetLeft,o();var p=h?'hidden':'auto';return o((0,_utils.animate)(_this3.track,{prop:'scrollLeft',delta:n,easing:e,duration:f,originalOverflowX:p}))}).then(function(){if(_this3.setState({isAnimating:!1}),m!==l)return c(l)}).catch(function(){_this3.setState({isAnimating:!1})})}},{key:'render',value:function render(){var _props2=this.props,a=_props2.afterSlide,b=_props2.animationDuration,c=_props2.beforeSlide,d=_props2.children,e=_props2.className,f=_props2.easing,g=_props2.infinite,h=_props2.gutter,j=_props2.nextKeys,k=_props2.prevKeys,l=_props2.preventScroll,m=_props2.preventSwipe,n=_props2.snapToSlide,o=_props2.onSlideClick,p=_props2.slideClass,q=_props2.slideTo,r=_props2.slideBy,s=_props2.startAt,t=_props2.style,u=_props2.visibleSlides,v=_objectWithoutProperties(_props2,['afterSlide','animationDuration','beforeSlide','children','className','easing','infinite','gutter','nextKeys','prevKeys','preventScroll','preventSwipe','snapToSlide','onSlideClick','slideClass','slideTo','slideBy','startAt','style','visibleSlides']),w=this.state.isAnimating,x=l||w?'hidden':'auto';return _react2.default.createElement('div',_extends({className:e,style:_extends({},t,{display:'flex',flexFlow:'row nowrap',justifyContent:'space-between',overflowX:x,msOverflowStyle:'-ms-autohiding-scrollbar',/* chrome like scrollbar experience for IE/Edge */position:'relative',/* makes .track an offset parent */transition:'all .25s ease-in-quint',outline:'none',WebkitOverflowScrolling:'touch'}),ref:this.setRef('track'),tabIndex:'0',onKeyUp:this.handleKeyUp},v),_react.Children.map('function'==typeof d?d(this.next,this.prev):d,function(y,z){return _react2.default.createElement(_slide2.default,{className:p,key:'slide-'+z,basis:u?'calc((100% - ('+h+' * '+(u-1)+')) / '+u+')':'auto',gutter:0<z?h:'',onClick:o},y)}))}}]),Track}(_react.Component);Track.propTypes={afterSlide:func,animationDuration:number,beforeSlide:func,children:oneOfType([node,array,string]),className:oneOfType([array,string,object]),easing:func,infinite:bool,nextKeys:array,prevKeys:array,preventScroll:bool,preventSwipe:bool,onSlideClick:func,snapToSlide:bool,slideTo:number,slideToCenter:bool,slideBy:number,slideClass:oneOfType([array,string,object]),startAt:number,style:object,gutter:function gutter(a,b,c){var d=a[b];if('number'==typeof parseInt(d,10)&&!isNaN(+d))return new Error('Invalid value ('+d+') of prop \''+b+'\' supplied to '+c+'.\n        The value of '+b+' should be a valid css length unit\n        (https://developer.mozilla.org/en-US/docs/Web/CSS/length).')},visibleSlides:number};Track.defaultProps={afterSlide:function afterSlide(){},animationDuration:500,beforeSlide:function beforeSlide(){},gutter:'1em',nextKeys:['ArrowRight'],prevKeys:['ArrowLeft'],preventScroll:!1,preventSwipe:!1,snapToSlide:!1,startAt:0,style:{}};var _initialiseProps=function _initialiseProps(){var _this4=this;this.eventListeners=[],this.isScrolling=!1,this.canSelfCorrect=function(){return!_this4.state.isAnimating&&!_this4.isScrolling&&!_this4.isInteracting()},this.shouldSelfCorrect=function(){return _this4.props.snapToSlide&&_this4.canSelfCorrect()},this.handleKeyUp=function(a,b){return function(_ref4){var c=_ref4.key,d=(0,_utils.includes)(c,a),e=(0,_utils.includes)(c,b);return _this4.setState({isAnimating:!0}),d&&_this4.next().catch(_utils.noop),e&&_this4.prev().catch(_utils.noop),!1}}(this.props.nextKeys,this.props.prevKeys),this.getPartiallyObscuredSlides=function(){var a=_this4.track,b=[].concat(_toConsumableArray(a.children)).findIndex(function(f,g,h){return!(0,_utils.isWhollyInView)(a)(f)&&(0,_utils.isWhollyInView)(a)(h[g+1])}),c=Math.max(b,0),d=[].concat(_toConsumableArray(a.children)).findIndex(function(f,g,h){return!(0,_utils.isWhollyInView)(a)(f)&&(0,_utils.isWhollyInView)(a)(h[g-1])}),e=Math.max(d,0)||a.children.length-1;return[c,e]},this.getNearestSlideIndex=function(){var _track2=_this4.track,a=_track2.children,b=_track2.scrollLeft,c=[].slice.call(a).map(function(_ref5){var d=_ref5.offsetLeft;return Math.abs(d-b)});return c.indexOf(Math.min.apply(Math,_toConsumableArray(c)))},this.setRef=function(a){return function(b){_this4[a]=b}}};exports.default=Track;