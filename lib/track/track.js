'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h['return']&&h['return']()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_react=require('react'),_react2=_interopRequireDefault(_react),_propTypes=require('prop-types'),_propTypes2=_interopRequireDefault(_propTypes),_reactDom=require('react-dom'),_slide=require('../slide'),_slide2=_interopRequireDefault(_slide),_utils=require('../utils');Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _objectWithoutProperties(a,b){var c={};for(var d in a)0<=b.indexOf(d)||Object.prototype.hasOwnProperty.call(a,d)&&(c[d]=a[d]);return c}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a}function _inherits(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var bool=_propTypes2.default.bool,number=_propTypes2.default.number,string=_propTypes2.default.string,func=_propTypes2.default.func,array=_propTypes2.default.array,oneOfType=_propTypes2.default.oneOfType,object=_propTypes2.default.object,node=_propTypes2.default.node,wrapAroundValue=function(a,b){return(a%b+b)%b},hardBoundedValue=function(a,b){return Math.max(0,Math.min(b,a))},normalizeIndex=function(a,b){var c=2<arguments.length&&arguments[2]!==void 0&&arguments[2];return c?wrapAroundValue(a,b):hardBoundedValue(a,b-1)},Track=function(a){function b(a){_classCallCheck(this,b);var c=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return _initialiseProps.call(c),c.state={activeIndex:a.startAt,isAnimating:!1,visibleSlides:c.props.visibleSlides||0,slideBy:c.props.slideBy||c.props.visibleSlides||0},c.next=c.next.bind(c),c.prev=c.prev.bind(c),c.slideTo=c.slideTo.bind(c),c}return _inherits(b,a),_createClass(b,[{key:'componentDidMount',value:function componentDidMount(){var a=this;this.DOMNode=(0,_reactDom.findDOMNode)(this.track),this.isInteracting=(0,_utils.hasOngoingInteraction)(this.DOMNode),this.childCount=this.track&&this.track.children?this.track.children.length:0;var b={left:function left(){return-a.state.slideBy},right:function right(){return a.state.slideBy},up:function up(){return 0},down:function down(){return 0}};this.eventListeners=[].concat(_toConsumableArray(this.eventListeners),[(0,_utils.onScrollStart)(function(){a.isScrolling=!0}),(0,_utils.on)('touchstart')(function(){a.isScrolling=!0})(this.track),(0,_utils.onScrollEnd)(function(){a.isScrolling=!1,a.canSelfCorrect()&&(a.props.snapToSlide?a.slideTo(a.getNearestSlideIndex()).catch(_utils.noop):a.props.afterSlide(a.getNearestSlideIndex()))},{target:this.DOMNode}),(0,_utils.on)('touchend')(function(){a.canSelfCorrect()&&(a.props.snapToSlide?a.slideTo(a.getNearestSlideIndex()).catch(_utils.noop):a.props.afterSlide(a.getNearestSlideIndex()))})(this.track),(0,_utils.onSwipe)(function(c){!a.props.preventSwipe&&a.props.snapToSlide&&a.slideTo(a.state.activeIndex+b[c]()).catch(_utils.noop)})(this.track)]),this.slideTo(this.props.startAt,{immediate:!0}).catch(_utils.noop)}},{key:'componentWillUnmount',value:function componentWillUnmount(){this.eventListeners.forEach(function(a){return a()})}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(a){var b=a.slideBy,c=a.visibleSlides;(b!==this.props.slideBy||c!==this.props.visibleSlides)&&this.setState({slideBy:b||c||1})}},{key:'componentDidUpdate',value:function componentDidUpdate(a){if(this.childCount=this.track&&this.track.children?this.track.children.length:0,this.shouldSelfCorrect()){var b=this.getNearestSlideIndex();b!==this.state.activeIndex&&this.slideTo(this.getNearestSlideIndex()).catch(_utils.noop)}a.slideTo!==this.props.slideTo&&this.slideTo(this.props.slideTo).catch(_utils.noop)}},{key:'shouldComponentUpdate',value:function shouldComponentUpdate(a,b){var c=b.isAnimating,d=[].concat(_toConsumableArray((0,_utils.values)(this.props)),[this.state.isAnimating]),e=[].concat(_toConsumableArray((0,_utils.values)(a)),[c]);return!e.every(function(a,b){return a===d[b]})}},{key:'next',value:function next(){var a=this.childCount,b=this.props,c=this.state,d=c.activeIndex,e=c.slideBy,f=b.infinite,g=a-e;if(!e){var h=this.getPartiallyObscuredSlides(),i=_slicedToArray(h,2),j=i[0],k=i[1],l=k===a-1?0:k;return this.slideTo(f?l:k)}var m=Math.min(d+e,g),n=d===g?0:m;return this.slideTo(f?n:m)}},{key:'prev',value:function prev(){var a=this.childCount,b=this.state,c=this.props,d=b.activeIndex,e=b.slideBy,f=c.infinite,g=0;if(!e){var h=this.getPartiallyObscuredSlides(),i=_slicedToArray(h,1),j=i[0],k=j===g?a-1:j;return this.slideTo(f?k:j)}var l=Math.max(d-e,g),m=l===g?a-e:l;return this.slideTo(f?m:l)}},{key:'slideTo',value:function slideTo(a){var b=this,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},d=c.immediate;if(0===this.childCount)return Promise.reject('No children to slide to');if(!this.track)return Promise.reject('The Track is not mounted');var e=this.props,f=e.afterSlide,g=e.beforeSlide,h=e.easing,i=e.animationDuration,j=e.infinite,k=e.preventScroll,l=this.track,m=l.children,n=l.scrollLeft,o=normalizeIndex(a,this.childCount,j),p=this.state.activeIndex,q=m[o].offsetLeft-n;return p!==o&&g(a),this.setState({isAnimating:!0,activeIndex:o}),new Promise(function(a){if(void 0!==d&&d)return b.track.scrollLeft=m[o].offsetLeft,a();var c=k?'hidden':'auto';return a((0,_utils.animate)(b.track,{prop:'scrollLeft',delta:q,easing:h,duration:i,originalOverflowX:c}))}).then(function(){if(b.setState({isAnimating:!1}),p!==o)return f(o)}).catch(function(){b.setState({isAnimating:!1})})}},{key:'render',value:function render(){var a=this.props,b=a.afterSlide,c=a.animationDuration,d=a.beforeSlide,e=a.children,f=a.className,g=a.easing,h=a.infinite,i=a.innerRef,j=a.gutter,k=a.nextKeys,l=a.prevKeys,m=a.preventScroll,n=a.preventAutoCorrect,o=a.preventSwipe,p=a.snapToSlide,q=a.onSlideClick,r=a.slideClass,s=a.slideTo,t=a.slideBy,u=a.startAt,v=a.style,w=a.visibleSlides,x=_objectWithoutProperties(a,['afterSlide','animationDuration','beforeSlide','children','className','easing','infinite','innerRef','gutter','nextKeys','prevKeys','preventScroll','preventAutoCorrect','preventSwipe','snapToSlide','onSlideClick','slideClass','slideTo','slideBy','startAt','style','visibleSlides']),y=m?'hidden':'auto';return _react2.default.createElement('div',_extends({className:f,style:_extends({},v,{display:'flex',flexFlow:'row nowrap',justifyContent:'space-between',overflowX:y,msOverflowStyle:'-ms-autohiding-scrollbar',position:'relative',transition:'all .25s ease-in-quint',outline:'none',WebkitOverflowScrolling:'touch'}),ref:this.setRef('track'),tabIndex:'0',onKeyUp:this.handleKeyUp},x),_react.Children.map('function'==typeof e?e(this.next,this.prev):e,function(a,b){return _react2.default.createElement(_slide2.default,{className:r,key:'slide-'+b,basis:w?'calc((100% - ('+j+' * '+(w-1)+')) / '+w+')':'auto',gutter:0<b?j:'',onClick:q},a)}))}}]),b}(_react.Component);Track.propTypes={afterSlide:func,animationDuration:number,beforeSlide:func,children:oneOfType([node,array,string]),className:oneOfType([array,string,object]),easing:func,infinite:bool,innerRef:func,nextKeys:array,prevKeys:array,preventAutoCorrect:bool,preventScroll:bool,preventSwipe:bool,onSlideClick:func,snapToSlide:bool,slideTo:number,slideToCenter:bool,slideBy:number,slideClass:oneOfType([array,string,object]),startAt:number,style:object,gutter:function gutter(a,b,c){var d=a[b];if('number'==typeof parseInt(d,10)&&!isNaN(+d))return new Error('Invalid value ('+d+') of prop \''+b+'\' supplied to '+c+'.\n        The value of '+b+' should be a valid css length unit\n        (https://developer.mozilla.org/en-US/docs/Web/CSS/length).')},visibleSlides:number},Track.defaultProps={afterSlide:function afterSlide(){},animationDuration:500,beforeSlide:function beforeSlide(){},gutter:'1em',nextKeys:['ArrowRight'],prevKeys:['ArrowLeft'],preventAutoCorrect:!1,preventScroll:!1,preventSwipe:!1,snapToSlide:!1,startAt:0,style:{}};var _initialiseProps=function(){var a=Math.max,b=this;this.eventListeners=[],this.isScrolling=!1,this.canSelfCorrect=function(){return!b.props.preventAutoCorrect&&!b.state.isAnimating&&!b.isScrolling&&!b.isInteracting()},this.shouldSelfCorrect=function(){return b.props.snapToSlide&&b.canSelfCorrect()},this.handleKeyUp=function(a,c){return function(d){var e=d.key,f=(0,_utils.includes)(e,a),g=(0,_utils.includes)(e,c);return b.setState({isAnimating:!0}),f&&b.next().catch(_utils.noop),g&&b.prev().catch(_utils.noop),!1}}(this.props.nextKeys,this.props.prevKeys),this.getPartiallyObscuredSlides=function(){var c=b.track,d=[].concat(_toConsumableArray(c.children)).findIndex(function(a,b,d){return!(0,_utils.isWhollyInView)(c)(a)&&(0,_utils.isWhollyInView)(c)(d[b+1])}),e=a(d,0),f=[].concat(_toConsumableArray(c.children)).findIndex(function(a,b,d){return!(0,_utils.isWhollyInView)(c)(a)&&(0,_utils.isWhollyInView)(c)(d[b-1])}),g=a(f,0)||c.children.length-1;return[e,g]},this.getNearestSlideIndex=function(){var a=b.track,c=a.children,d=a.scrollLeft,e=[].slice.call(c).map(function(a){var b=a.offsetLeft;return Math.abs(b-d)});return e.indexOf(Math.min.apply(Math,_toConsumableArray(e)))},this.setRef=function(a){return function(c){b[a]=c}}};exports.default=Track;